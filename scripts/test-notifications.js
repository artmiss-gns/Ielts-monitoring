#!/usr/bin/env node

const { NotificationService } = require('../dist/services/NotificationService');
const fs = require('fs-extra');
const path = require('path');

/**
 * Test notification system with sample appointments
 */
async function testNotifications() {
  console.log('üîî Testing IELTS Appointment Notification System\n');
  
  const notificationService = new NotificationService();
  
  // Sample appointments for testing
  const testAppointments = [
    {
      id: 'test-notification-1',
      date: '2024-03-15',
      time: '09:00',
      location: 'Isfahan Test Center',
      examType: 'IELTS',
      city: 'Isfahan',
      status: 'available'
    },
    {
      id: 'test-notification-2',
      date: '2024-03-20',
      time: '14:30',
      location: 'Tehran Test Center',
      examType: 'IELTS',
      city: 'Tehran',
      status: 'available'
    }
  ];

  console.log('üìã Test appointments:');
  testAppointments.forEach((apt, index) => {
    console.log(`   ${index + 1}. ${apt.date} at ${apt.time} - ${apt.location}`);
  });
  console.log('');

  // Test 1: Desktop notification only
  console.log('üñ•Ô∏è  Test 1: Desktop Notification');
  console.log('   This should show a desktop notification popup...');
  try {
    const result1 = await notificationService.sendNotification(testAppointments, {
      desktop: true,
      audio: false,
      logFile: false
    });
    console.log(`   ‚úÖ Desktop notification: ${result1.deliveryStatus}`);
    console.log(`   üìä Channels used: ${result1.channels.join(', ')}`);
  } catch (error) {
    console.log(`   ‚ùå Desktop notification failed: ${error.message}`);
  }
  console.log('');

  // Wait a moment between tests
  await delay(2000);

  // Test 2: Audio alert only
  console.log('üîä Test 2: Audio Alert');
  console.log('   This should play a system sound...');
  try {
    const result2 = await notificationService.sendNotification(testAppointments, {
      desktop: false,
      audio: true,
      logFile: false
    });
    console.log(`   ‚úÖ Audio alert: ${result2.deliveryStatus}`);
    console.log(`   üìä Channels used: ${result2.channels.join(', ')}`);
  } catch (error) {
    console.log(`   ‚ùå Audio alert failed: ${error.message}`);
  }
  console.log('');

  // Wait a moment between tests
  await delay(2000);

  // Test 3: Log file notification only
  console.log('üìù Test 3: Log File Notification');
  console.log('   This should write to logs/notifications.log...');
  try {
    const result3 = await notificationService.sendNotification(testAppointments, {
      desktop: false,
      audio: false,
      logFile: true
    });
    console.log(`   ‚úÖ Log file notification: ${result3.deliveryStatus}`);
    console.log(`   üìä Channels used: ${result3.channels.join(', ')}`);
    
    // Check if log file was created
    const logPath = path.join('logs', 'notifications.log');
    if (await fs.pathExists(logPath)) {
      const logContent = await fs.readFile(logPath, 'utf8');
      const lines = logContent.trim().split('\n');
      console.log(`   üìÑ Log file has ${lines.length} entries`);
    }
  } catch (error) {
    console.log(`   ‚ùå Log file notification failed: ${error.message}`);
  }
  console.log('');

  // Wait a moment between tests
  await delay(2000);

  // Test 4: All notifications enabled
  console.log('üéØ Test 4: All Notification Channels');
  console.log('   This should trigger desktop, audio, and log file notifications...');
  try {
    const result4 = await notificationService.sendNotification(testAppointments, {
      desktop: true,
      audio: true,
      logFile: true
    });
    console.log(`   ‚úÖ All notifications: ${result4.deliveryStatus}`);
    console.log(`   üìä Channels used: ${result4.channels.join(', ')}`);
    console.log(`   üìà Appointment count: ${result4.appointmentCount}`);
  } catch (error) {
    console.log(`   ‚ùå All notifications failed: ${error.message}`);
  }
  console.log('');

  // Test 5: Single appointment notification
  console.log('üì± Test 5: Single Appointment Notification');
  console.log('   This should show a notification for just one appointment...');
  try {
    const singleAppointment = [testAppointments[0]];
    const result5 = await notificationService.sendNotification(singleAppointment, {
      desktop: true,
      audio: false,
      logFile: true
    });
    console.log(`   ‚úÖ Single appointment notification: ${result5.deliveryStatus}`);
    console.log(`   üìä Channels used: ${result5.channels.join(', ')}`);
  } catch (error) {
    console.log(`   ‚ùå Single appointment notification failed: ${error.message}`);
  }
  console.log('');

  // Test 6: Check notification history
  console.log('üìö Test 6: Notification History');
  try {
    const history = await notificationService.getNotificationHistory(5);
    console.log(`   üìä Found ${history.length} notifications in history`);
    
    if (history.length > 0) {
      console.log('   üìã Recent notifications:');
      history.forEach((record, index) => {
        console.log(`      ${index + 1}. ${record.timestamp.toISOString()} - ${record.appointmentCount} appointments`);
      });
    }

    const stats = await notificationService.getNotificationStats();
    console.log(`   üìà Statistics:`);
    console.log(`      Total notifications: ${stats.totalNotifications}`);
    console.log(`      Total appointments: ${stats.totalAppointments}`);
    console.log(`      Average per notification: ${stats.averageAppointmentsPerNotification.toFixed(1)}`);
    if (stats.lastNotification) {
      console.log(`      Last notification: ${stats.lastNotification.toISOString()}`);
    }
  } catch (error) {
    console.log(`   ‚ùå History check failed: ${error.message}`);
  }
  console.log('');

  // Final summary
  console.log('=' .repeat(60));
  console.log('üéâ Notification Testing Complete!');
  console.log('=' .repeat(60));
  console.log('');
  console.log('üí° What to expect:');
  console.log('   ‚Ä¢ Desktop notifications should appear as system popups');
  console.log('   ‚Ä¢ Audio alerts should play system sounds');
  console.log('   ‚Ä¢ Log entries should be written to logs/notifications.log');
  console.log('');
  console.log('üîç To verify:');
  console.log('   ‚Ä¢ Check your system notifications');
  console.log('   ‚Ä¢ Listen for audio alerts');
  console.log('   ‚Ä¢ Check logs/notifications.log file');
  console.log('');
}

/**
 * Interactive notification test
 */
async function interactiveTest() {
  const readline = require('readline');
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  const question = (prompt) => new Promise(resolve => rl.question(prompt, resolve));

  console.log('üéÆ Interactive Notification Test');
  console.log('This will let you test specific notification types.\n');

  const notificationService = new NotificationService();
  
  const testAppointment = {
    id: 'interactive-test',
    date: '2024-04-01',
    time: '10:00',
    location: 'Interactive Test Center',
    examType: 'IELTS',
    city: 'Isfahan',
    status: 'available'
  };

  while (true) {
    console.log('\nüìã Choose a notification type to test:');
    console.log('1. Desktop notification');
    console.log('2. Audio alert');
    console.log('3. Log file notification');
    console.log('4. All notifications');
    console.log('5. View notification history');
    console.log('6. Exit');

    const choice = await question('\nEnter your choice (1-6): ');

    switch (choice.trim()) {
      case '1':
        console.log('\nüñ•Ô∏è  Sending desktop notification...');
        try {
          await notificationService.sendNotification([testAppointment], {
            desktop: true,
            audio: false,
            logFile: false
          });
          console.log('‚úÖ Desktop notification sent! Check your system notifications.');
        } catch (error) {
          console.log(`‚ùå Failed: ${error.message}`);
        }
        break;

      case '2':
        console.log('\nüîä Playing audio alert...');
        try {
          await notificationService.sendNotification([testAppointment], {
            desktop: false,
            audio: true,
            logFile: false
          });
          console.log('‚úÖ Audio alert played! Did you hear it?');
        } catch (error) {
          console.log(`‚ùå Failed: ${error.message}`);
        }
        break;

      case '3':
        console.log('\nüìù Writing to log file...');
        try {
          await notificationService.sendNotification([testAppointment], {
            desktop: false,
            audio: false,
            logFile: true
          });
          console.log('‚úÖ Log entry written! Check logs/notifications.log');
        } catch (error) {
          console.log(`‚ùå Failed: ${error.message}`);
        }
        break;

      case '4':
        console.log('\nüéØ Sending all notification types...');
        try {
          const result = await notificationService.sendNotification([testAppointment], {
            desktop: true,
            audio: true,
            logFile: true
          });
          console.log(`‚úÖ All notifications sent! Status: ${result.deliveryStatus}`);
          console.log(`üìä Channels: ${result.channels.join(', ')}`);
        } catch (error) {
          console.log(`‚ùå Failed: ${error.message}`);
        }
        break;

      case '5':
        console.log('\nüìö Notification History:');
        try {
          const history = await notificationService.getNotificationHistory(10);
          if (history.length === 0) {
            console.log('No notifications found in history.');
          } else {
            history.forEach((record, index) => {
              console.log(`${index + 1}. ${record.timestamp.toLocaleString()} - ${record.appointmentCount} appointments`);
            });
          }
        } catch (error) {
          console.log(`‚ùå Failed: ${error.message}`);
        }
        break;

      case '6':
        console.log('\nüëã Goodbye!');
        rl.close();
        return;

      default:
        console.log('\n‚ùå Invalid choice. Please enter 1-6.');
    }
  }
}

/**
 * Utility function for delays
 */
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/**
 * Main function
 */
async function main() {
  const args = process.argv.slice(2);
  
  if (args.includes('--interactive') || args.includes('-i')) {
    await interactiveTest();
  } else {
    await testNotifications();
  }
}

// Handle process termination
process.on('SIGINT', () => {
  console.log('\n\nüëã Testing interrupted. Goodbye!');
  process.exit(0);
});

// Run the tests
main().catch(error => {
  console.error('‚ùå Test failed:', error);
  process.exit(1);
});